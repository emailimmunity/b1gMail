<?php
/**
 * SabreDAV Auth-Backend - Password V2 Integration
 * 
 * PATCH für src/serverlib/organizerdav.inc.php
 * 
 * Erweitert BMAuthBackend um:
 * - bcrypt-Support
 * - App-Passwords
 * - MFA-Kompatibilität
 */

// ═══════════════════════════════════════════════════════════════
// REPLACE validateUserPass() METHOD IN BMAuthBackend CLASS
// ═══════════════════════════════════════════════════════════════

function validateUserPass($username, $password)
{
	global $db;

	// get user ID
	$userID = BMUser::GetID($username);
	if($userID == 0)
		return false;

	// get user object + row
	$this->userObject = _new('BMUser', array($userID));
	$this->userRow = $this->userObject->Fetch();
	if(!$this->userRow)
		return false;

	// get group object + row
	$this->groupObject = _new('BMGroup', array($this->userRow['gruppe']));
	$this->groupRow = $this->groupObject->Fetch();

	// ═══════════════════════════════════════════════════════════════
	// PERMISSION CHECK (as before)
	// ═══════════════════════════════════════════════════════════════
	
	if(!$this->checkPermissions())
		return false;

	// ═══════════════════════════════════════════════════════════════
	// PASSWORD VERIFICATION (EXTENDED for bcrypt + App-Passwords!)
	// ═══════════════════════════════════════════════════════════════
	
	require_once(B1GMAIL_DIR . 'serverlib/password.class.php');
	require_once(B1GMAIL_DIR . 'serverlib/app-passwords.class.php');
	
	// METHOD 1: Main password (bcrypt/MD5 hybrid)
	try
	{
		$valid = PasswordManager::verify(
			$password,
			$this->userRow['passwort'],
			$this->userRow['password_version'] ?? 1,
			$this->userRow['passwort_salt']
		);
		
		if($valid)
		{
			$this->setupState();
			
			PutLog(sprintf('DAV auth success (main password) for user %s',
			              $username),
			       PRIO_NOTE,
			       __FILE__,
			       __LINE__);
			
			return true;
		}
	}
	catch(Exception $e)
	{
		// Fallback to legacy if PasswordManager fails
		PutLog('PasswordManager failed, trying legacy: ' . $e->getMessage(),
		       PRIO_WARNING,
		       __FILE__,
		       __LINE__);
	}
	
	// METHOD 2: App password (for 2FA users)
	try
	{
		$appPW = new BMAppPasswords($userID);
		
		// Detect protocol from REQUEST_URI
		$protocol = 'caldav'; // Default
		
		if(isset($_SERVER['REQUEST_URI']))
		{
			if(stripos($_SERVER['REQUEST_URI'], '/carddav') !== false)
			{
				$protocol = 'carddav';
			}
			else if(stripos($_SERVER['REQUEST_URI'], '/webdav') !== false)
			{
				$protocol = 'webdav';
			}
			else if(stripos($_SERVER['REQUEST_URI'], 'dav.php') !== false 
			        && isset($_SERVER['HTTP_USER_AGENT']))
			{
				// Auto-detect from User-Agent
				$ua = strtolower($_SERVER['HTTP_USER_AGENT']);
				
				if(strpos($ua, 'caldav') !== false)
					$protocol = 'caldav';
				else if(strpos($ua, 'carddav') !== false)
					$protocol = 'carddav';
			}
		}
		
		if($appPW->verify($password, $protocol))
		{
			$this->setupState();
			
			PutLog(sprintf('DAV auth success (app password) for user %s via %s',
			              $username, $protocol),
			       PRIO_NOTE,
			       __FILE__,
			       __LINE__);
			
			return true;
		}
	}
	catch(Exception $e)
	{
		// App passwords might not be available yet
		PutLog('App password check failed: ' . $e->getMessage(),
		       PRIO_DEBUG,
		       __FILE__,
		       __LINE__);
	}
	
	// ═══════════════════════════════════════════════════════════════
	// FALLBACK: Legacy MD5 check (for backwards compatibility)
	// ═══════════════════════════════════════════════════════════════
	
	$md5Pass = md5($password);
	if($md5Pass === $this->userRow['passwort'] 
	   || md5($md5Pass . $this->userRow['passwort_salt']) === $this->userRow['passwort'])
	{
		$this->setupState();
		
		PutLog(sprintf('DAV auth success (legacy MD5) for user %s',
		              $username),
		       PRIO_NOTE,
		       __FILE__,
		       __LINE__);
		
		return true;
	}

	// AUTH FAILED
	PutLog(sprintf('DAV auth failed for user %s',
	              $username),
	       PRIO_WARNING,
	       __FILE__,
	       __LINE__);
	
	return false;
}

?>

